# Receipt Processor

A webservice that processes and calculates points for a receipt. The calculated points are stored in-memory associated with a randomly generated id. The post API is responsible for doing this and returns the id back to the client. Doing a get request on this id, will return the points associated with the receipt.

## Running the application

There are 2 options to run this application

### Docker

##### Pre-req
1. You need to have docker (and docker compose) installed

#### Run the application:
1. Building the docker image ```docker-compose build```
2. Running the image in a container ```docker-compose up```


### Manual

#### Pre-req
You need to have Go installed

#### Install dependencies
```
go mod download
```

#### Running tests and generating coverage data
1. Running tests and generating coverage: ```go test -coverprofile=coverage ./...```
2. Generating an html file to easily view coverage results: ```go tool cover -html=coverage -o coverage.html```


#### Run the application:
1. Building the application: ```go build -o receipt-processor main.go```
2. Running the application: ```./receipt-processor```

## Note

* The service does the processing of receipt during the write operation. This makes the read operations very light. If the service however is write heavy, the roles of the APIs can be switched.
* The API validators have been written per the specifications defined in the yml file. However, the retailer and the shortDescripton have not been validated per the regex. This is because the example (M&M Corner Market) provided do not satisfy the regex and would throw an error.

## Improvements

* Database can be added for persistence
* Validators can be extended to send custom error messages
* Logging middleware can be extended to write to a log file
* Thread support can be added in the repository
* Code coverage can be improved

## Project Structure

### controller
The controller acts as an interface between the client and the application.
It handles user input and delegates further processing to appropriate services or models.
It is responsible for controlling the flow of the application.

### middleware
Middleware intercepts and manipulates requests and responses.
It helps in keeping the application's core logic clean and decoupled from cross-cutting concerns.

### model
It defines the structure and behavior of data entities or objects used by the application. It includes validation logic to ensure data is valid before reaching the business logic. 

### repository
The repository provides an abstraction layer between the application and the data storage.
It encapsulates the logic required to access and manipulate data which in our case is an in-memory map.

### service
Service layer houses the business logic of the application. In this case, prcoessing of the receipt resides here.

### utils
The utils package typically contains reusable functions or classes that provide common functionality used across the application. In this case, I have used it for string manipulation and perform validations.

## Patterns

The repository uses the Singleton pattern to ensure connections will be reused across multiple requests. It also ensures that all parts of the application interact with the same repository instance, promoting consistency and predictability in data access and manipulation. 

## API Specification

### Endpoint: Process Receipts

* Path: `/receipts/process`
* Method: `POST`
* Payload: Receipt JSON
* Response: JSON containing an id for the receipt.

Description:

Takes in a JSON receipt (see example in the example directory) and returns a JSON object with an ID generated by your code.

The ID returned is the ID that should be passed into `/receipts/{id}/points` to get the number of points the receipt
was awarded.

Example Response:
```json
{ "id": "7fb1377b-b223-49d9-a31a-5a02701dd310" }
```

## Endpoint: Get Points

* Path: `/receipts/{id}/points`
* Method: `GET`
* Response: A JSON object containing the number of points awarded.

A simple Getter endpoint that looks up the receipt by the ID and returns an object specifying the points awarded.

Example Response:
```json
{ "points": 32 }
```

---

# Rules

These rules collectively define how many points should be awarded to a receipt.

* One point for every alphanumeric character in the retailer name.
* 50 points if the total is a round dollar amount with no cents.
* 25 points if the total is a multiple of `0.25`.
* 5 points for every two items on the receipt.
* If the trimmed length of the item description is a multiple of 3, multiply the price by `0.2` and round up to the nearest integer. The result is the number of points earned.
* 6 points if the day in the purchase date is odd.
* 10 points if the time of purchase is after 2:00pm and before 4:00pm.


## Examples

```json
{
  "retailer": "Target",
  "purchaseDate": "2022-01-01",
  "purchaseTime": "13:01",
  "items": [
    {
      "shortDescription": "Mountain Dew 12PK",
      "price": "6.49"
    },{
      "shortDescription": "Emils Cheese Pizza",
      "price": "12.25"
    },{
      "shortDescription": "Knorr Creamy Chicken",
      "price": "1.26"
    },{
      "shortDescription": "Doritos Nacho Cheese",
      "price": "3.35"
    },{
      "shortDescription": "   Klarbrunn 12-PK 12 FL OZ  ",
      "price": "12.00"
    }
  ],
  "total": "35.35"
}
```
```text
Total Points: 28
Breakdown:
     6 points - retailer name has 6 characters
    10 points - 4 items (2 pairs @ 5 points each)
     3 Points - "Emils Cheese Pizza" is 18 characters (a multiple of 3)
                item price of 12.25 * 0.2 = 2.45, rounded up is 3 points
     3 Points - "Klarbrunn 12-PK 12 FL OZ" is 24 characters (a multiple of 3)
                item price of 12.00 * 0.2 = 2.4, rounded up is 3 points
     6 points - purchase day is odd
  + ---------
  = 28 points
```

----

```json
{
  "retailer": "M&M Corner Market",
  "purchaseDate": "2022-03-20",
  "purchaseTime": "14:33",
  "items": [
    {
      "shortDescription": "Gatorade",
      "price": "2.25"
    },{
      "shortDescription": "Gatorade",
      "price": "2.25"
    },{
      "shortDescription": "Gatorade",
      "price": "2.25"
    },{
      "shortDescription": "Gatorade",
      "price": "2.25"
    }
  ],
  "total": "9.00"
}
```
```text
Total Points: 109
Breakdown:
    50 points - total is a round dollar amount
    25 points - total is a multiple of 0.25
    14 points - retailer name (M&M Corner Market) has 14 alphanumeric characters
                note: '&' is not alphanumeric
    10 points - 2:33pm is between 2:00pm and 4:00pm
    10 points - 4 items (2 pairs @ 5 points each)
  + ---------
  = 109 points
```
